#!/bin/bash

# MateOS Plugins System
# Sistema de plugins para MateOS

MATEOS_PATH="${MATEOS_PATH:-$HOME/.local/share/mateOS}"
PLUGINS_DIR="$HOME/.config/mateOS/plugins"
PLUGINS_CONFIG="$HOME/.config/mateOS/plugins.conf"
PLUGINS_LOG="$HOME/.local/state/mateOS/logs/plugins.log"

# Crear directorios necesarios
mkdir -p "$PLUGINS_DIR" "$(dirname "$PLUGINS_LOG")"

# FunciÃ³n para logging de plugins
plugin_log() {
    local message="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] $message" >> "$PLUGINS_LOG"
}

# FunciÃ³n para instalar plugin
install_plugin() {
    local plugin_source="$1"
    local plugin_name="$2"
    
    if [ -z "$plugin_source" ]; then
        echo "âŒ Error: Debes especificar una fuente del plugin"
        echo "Uso: mateos-plugins install <fuente> [nombre]"
        return 1
    fi
    
    if [ -z "$plugin_name" ]; then
        plugin_name=$(basename "$plugin_source" .git)
    fi
    
    local plugin_dir="$PLUGINS_DIR/$plugin_name"
    
    if [ -d "$plugin_dir" ]; then
        echo "âŒ Error: El plugin '$plugin_name' ya estÃ¡ instalado"
        return 1
    fi
    
    echo "ğŸ“¦ Instalando plugin: $plugin_name"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # Clonar plugin
    if git clone "$plugin_source" "$plugin_dir" 2>/dev/null; then
        echo "âœ… Plugin clonado exitosamente"
    else
        echo "âŒ Error clonando plugin desde: $plugin_source"
        return 1
    fi
    
    # Verificar estructura del plugin
    if [ -f "$plugin_dir/plugin.conf" ]; then
        echo "âœ… ConfiguraciÃ³n del plugin encontrada"
    else
        echo "âš ï¸  Advertencia: No se encontrÃ³ plugin.conf"
    fi
    
    # Ejecutar script de instalaciÃ³n si existe
    if [ -f "$plugin_dir/install.sh" ]; then
        echo "ğŸ”§ Ejecutando script de instalaciÃ³n..."
        if bash "$plugin_dir/install.sh"; then
            echo "âœ… Script de instalaciÃ³n ejecutado"
        else
            echo "âŒ Error ejecutando script de instalaciÃ³n"
        fi
    fi
    
    # Registrar plugin
    echo "$plugin_name:$plugin_source:$(date)" >> "$PLUGINS_CONFIG"
    
    plugin_log "Plugin installed: $plugin_name from $plugin_source"
    
    echo "âœ… Plugin instalado exitosamente: $plugin_name"
}

# FunciÃ³n para desinstalar plugin
uninstall_plugin() {
    local plugin_name="$1"
    local confirm="${2:-false}"
    
    if [ -z "$plugin_name" ]; then
        echo "âŒ Error: Debes especificar un nombre de plugin"
        return 1
    fi
    
    local plugin_dir="$PLUGINS_DIR/$plugin_name"
    
    if [ ! -d "$plugin_dir" ]; then
        echo "âŒ Error: El plugin '$plugin_name' no estÃ¡ instalado"
        return 1
    fi
    
    if [ "$confirm" != "true" ]; then
        echo "âš ï¸  Â¿EstÃ¡s seguro de que quieres desinstalar el plugin '$plugin_name'?"
        echo "Esta acciÃ³n no se puede deshacer."
        read -p "Escribe 'yes' para confirmar: " confirm_input
        
        if [ "$confirm_input" != "yes" ]; then
            echo "âŒ OperaciÃ³n cancelada"
            return 1
        fi
    fi
    
    echo "ğŸ—‘ï¸  Desinstalando plugin: $plugin_name"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # Ejecutar script de desinstalaciÃ³n si existe
    if [ -f "$plugin_dir/uninstall.sh" ]; then
        echo "ğŸ”§ Ejecutando script de desinstalaciÃ³n..."
        if bash "$plugin_dir/uninstall.sh"; then
            echo "âœ… Script de desinstalaciÃ³n ejecutado"
        else
            echo "âŒ Error ejecutando script de desinstalaciÃ³n"
        fi
    fi
    
    # Eliminar directorio del plugin
    rm -rf "$plugin_dir"
    
    # Remover de configuraciÃ³n
    sed -i "/^$plugin_name:/d" "$PLUGINS_CONFIG"
    
    plugin_log "Plugin uninstalled: $plugin_name"
    
    echo "âœ… Plugin desinstalado exitosamente: $plugin_name"
}

# FunciÃ³n para listar plugins
list_plugins() {
    local status="${1:-all}"
    
    echo "ğŸ“‹ Plugins de MateOS:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    if [ ! -f "$PLUGINS_CONFIG" ]; then
        echo "No hay plugins instalados"
        return
    fi
    
    while IFS=: read -r name source date; do
        if [ -n "$name" ]; then
            local plugin_dir="$PLUGINS_DIR/$name"
            local plugin_status=""
            
            if [ -d "$plugin_dir" ]; then
                plugin_status="âœ… Instalado"
            else
                plugin_status="âŒ Roto"
            fi
            
            case "$status" in
                "installed")
                    if [ -d "$plugin_dir" ]; then
                        echo "  $plugin_status $name ($source)"
                    fi
                    ;;
                "broken")
                    if [ ! -d "$plugin_dir" ]; then
                        echo "  $plugin_status $name ($source)"
                    fi
                    ;;
                "all"|*)
                    echo "  $plugin_status $name ($source)"
                    ;;
            esac
        fi
    done < "$PLUGINS_CONFIG"
}

# FunciÃ³n para activar plugin
activate_plugin() {
    local plugin_name="$1"
    
    if [ -z "$plugin_name" ]; then
        echo "âŒ Error: Debes especificar un nombre de plugin"
        return 1
    fi
    
    local plugin_dir="$PLUGINS_DIR/$plugin_name"
    
    if [ ! -d "$plugin_dir" ]; then
        echo "âŒ Error: El plugin '$plugin_name' no estÃ¡ instalado"
        return 1
    fi
    
    echo "ğŸ”Œ Activando plugin: $plugin_name"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # Ejecutar script de activaciÃ³n si existe
    if [ -f "$plugin_dir/activate.sh" ]; then
        echo "ğŸ”§ Ejecutando script de activaciÃ³n..."
        if bash "$plugin_dir/activate.sh"; then
            echo "âœ… Plugin activado"
        else
            echo "âŒ Error activando plugin"
            return 1
        fi
    else
        echo "â„¹ï¸  No hay script de activaciÃ³n disponible"
    fi
    
    # Marcar como activo en configuraciÃ³n
    sed -i "s/^$plugin_name:/$plugin_name:active:/" "$PLUGINS_CONFIG"
    
    plugin_log "Plugin activated: $plugin_name"
    
    echo "âœ… Plugin activado exitosamente: $plugin_name"
}

# FunciÃ³n para desactivar plugin
deactivate_plugin() {
    local plugin_name="$1"
    
    if [ -z "$plugin_name" ]; then
        echo "âŒ Error: Debes especificar un nombre de plugin"
        return 1
    fi
    
    local plugin_dir="$PLUGINS_DIR/$plugin_name"
    
    if [ ! -d "$plugin_dir" ]; then
        echo "âŒ Error: El plugin '$plugin_name' no estÃ¡ instalado"
        return 1
    fi
    
    echo "ğŸ”Œ Desactivando plugin: $plugin_name"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # Ejecutar script de desactivaciÃ³n si existe
    if [ -f "$plugin_dir/deactivate.sh" ]; then
        echo "ğŸ”§ Ejecutando script de desactivaciÃ³n..."
        if bash "$plugin_dir/deactivate.sh"; then
            echo "âœ… Plugin desactivado"
        else
            echo "âŒ Error desactivando plugin"
            return 1
        fi
    else
        echo "â„¹ï¸  No hay script de desactivaciÃ³n disponible"
    fi
    
    # Marcar como inactivo en configuraciÃ³n
    sed -i "s/^$plugin_name:active:/$plugin_name:inactive:/" "$PLUGINS_CONFIG"
    
    plugin_log "Plugin deactivated: $plugin_name"
    
    echo "âœ… Plugin desactivado exitosamente: $plugin_name"
}

# FunciÃ³n para actualizar plugin
update_plugin() {
    local plugin_name="$1"
    
    if [ -z "$plugin_name" ]; then
        echo "âŒ Error: Debes especificar un nombre de plugin"
        return 1
    fi
    
    local plugin_dir="$PLUGINS_DIR/$plugin_name"
    
    if [ ! -d "$plugin_dir" ]; then
        echo "âŒ Error: El plugin '$plugin_name' no estÃ¡ instalado"
        return 1
    fi
    
    echo "ğŸ”„ Actualizando plugin: $plugin_name"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    cd "$plugin_dir"
    
    # Actualizar desde git
    if git pull origin main 2>/dev/null; then
        echo "âœ… Plugin actualizado desde repositorio"
    else
        echo "âŒ Error actualizando plugin desde repositorio"
        return 1
    fi
    
    # Ejecutar script de actualizaciÃ³n si existe
    if [ -f "$plugin_dir/update.sh" ]; then
        echo "ğŸ”§ Ejecutando script de actualizaciÃ³n..."
        if bash "$plugin_dir/update.sh"; then
            echo "âœ… Script de actualizaciÃ³n ejecutado"
        else
            echo "âŒ Error ejecutando script de actualizaciÃ³n"
        fi
    fi
    
    plugin_log "Plugin updated: $plugin_name"
    
    echo "âœ… Plugin actualizado exitosamente: $plugin_name"
}

# FunciÃ³n para crear plugin template
create_plugin_template() {
    local plugin_name="$1"
    local description="$2"
    
    if [ -z "$plugin_name" ]; then
        echo "âŒ Error: Debes especificar un nombre para el plugin"
        return 1
    fi
    
    local plugin_dir="$PLUGINS_DIR/$plugin_name"
    
    if [ -d "$plugin_dir" ]; then
        echo "âŒ Error: El plugin '$plugin_name' ya existe"
        return 1
    fi
    
    echo "ğŸ“ Creando template de plugin: $plugin_name"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    mkdir -p "$plugin_dir"
    
    # Crear archivo de configuraciÃ³n del plugin
    cat > "$plugin_dir/plugin.conf" << EOF
# MateOS Plugin Configuration
# ConfiguraciÃ³n del plugin: $plugin_name

[plugin]
name = "$plugin_name"
description = "${description:-Plugin personalizado para MateOS}"
version = "1.0.0"
author = "$(whoami)"
created = "$(date)"

[dependencies]
mateOS_version = "1.0.0"
required_scripts = "mateos-config,mateos-profile"

[hooks]
pre_install = "pre_install.sh"
post_install = "post_install.sh"
pre_uninstall = "pre_uninstall.sh"
post_uninstall = "post_uninstall.sh"
activate = "activate.sh"
deactivate = "deactivate.sh"
update = "update.sh"
EOF
    
    # Crear script de instalaciÃ³n
    cat > "$plugin_dir/install.sh" << EOF
#!/bin/bash
# Plugin Installation Script
# Script de instalaciÃ³n del plugin: $plugin_name

echo "Installing plugin: $plugin_name"
echo "Description: ${description:-Plugin personalizado para MateOS}"

# Crear directorios necesarios
mkdir -p "\$HOME/.config/mateOS/plugins/$plugin_name"

# Copiar archivos del plugin
cp -r . "\$HOME/.config/mateOS/plugins/$plugin_name/"

echo "Plugin $plugin_name installed successfully"
EOF
    
    chmod +x "$plugin_dir/install.sh"
    
    # Crear script de desinstalaciÃ³n
    cat > "$plugin_dir/uninstall.sh" << EOF
#!/bin/bash
# Plugin Uninstallation Script
# Script de desinstalaciÃ³n del plugin: $plugin_name

echo "Uninstalling plugin: $plugin_name"

# Eliminar archivos del plugin
rm -rf "\$HOME/.config/mateOS/plugins/$plugin_name"

echo "Plugin $plugin_name uninstalled successfully"
EOF
    
    chmod +x "$plugin_dir/uninstall.sh"
    
    # Crear script de activaciÃ³n
    cat > "$plugin_dir/activate.sh" << EOF
#!/bin/bash
# Plugin Activation Script
# Script de activaciÃ³n del plugin: $plugin_name

echo "Activating plugin: $plugin_name"

# AÃ±adir comandos de activaciÃ³n aquÃ­
# Ejemplo: exportar variables, cargar configuraciones, etc.

echo "Plugin $plugin_name activated successfully"
EOF
    
    chmod +x "$plugin_dir/activate.sh"
    
    # Crear script de desactivaciÃ³n
    cat > "$plugin_dir/deactivate.sh" << EOF
#!/bin/bash
# Plugin Deactivation Script
# Script de desactivaciÃ³n del plugin: $plugin_name

echo "Deactivating plugin: $plugin_name"

# AÃ±adir comandos de desactivaciÃ³n aquÃ­
# Ejemplo: limpiar variables, restaurar configuraciones, etc.

echo "Plugin $plugin_name deactivated successfully"
EOF
    
    chmod +x "$plugin_dir/deactivate.sh"
    
    # Crear script de actualizaciÃ³n
    cat > "$plugin_dir/update.sh" << EOF
#!/bin/bash
# Plugin Update Script
# Script de actualizaciÃ³n del plugin: $plugin_name

echo "Updating plugin: $plugin_name"

# AÃ±adir comandos de actualizaciÃ³n aquÃ­
# Ejemplo: migrar configuraciones, actualizar dependencias, etc.

echo "Plugin $plugin_name updated successfully"
EOF
    
    chmod +x "$plugin_dir/update.sh"
    
    # Crear README
    cat > "$plugin_dir/README.md" << EOF
# $plugin_name

${description:-Plugin personalizado para MateOS}

## InstalaciÃ³n

\`\`\`bash
mateos-plugins install $plugin_name
\`\`\`

## Uso

[Describe cÃ³mo usar el plugin aquÃ­]

## ConfiguraciÃ³n

[Describe la configuraciÃ³n del plugin aquÃ­]

## DesinstalaciÃ³n

\`\`\`bash
mateos-plugins uninstall $plugin_name
\`\`\`
EOF
    
    plugin_log "Plugin template created: $plugin_name"
    
    echo "âœ… Template de plugin creado: $plugin_name"
    echo "ğŸ“ UbicaciÃ³n: $plugin_dir"
    echo "ğŸ’¡ Edita los archivos para personalizar el plugin"
}

# FunciÃ³n para mostrar informaciÃ³n del plugin
show_plugin_info() {
    local plugin_name="$1"
    
    if [ -z "$plugin_name" ]; then
        echo "âŒ Error: Debes especificar un nombre de plugin"
        return 1
    fi
    
    local plugin_dir="$PLUGINS_DIR/$plugin_name"
    
    if [ ! -d "$plugin_dir" ]; then
        echo "âŒ Error: El plugin '$plugin_name' no estÃ¡ instalado"
        return 1
    fi
    
    echo "ğŸ“‹ InformaciÃ³n del plugin: $plugin_name"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # Mostrar configuraciÃ³n del plugin
    if [ -f "$plugin_dir/plugin.conf" ]; then
        echo "ConfiguraciÃ³n:"
        cat "$plugin_dir/plugin.conf"
        echo ""
    fi
    
    # Mostrar README si existe
    if [ -f "$plugin_dir/README.md" ]; then
        echo "DocumentaciÃ³n:"
        cat "$plugin_dir/README.md"
    fi
}

# FunciÃ³n principal
case "$1" in
    "install")
        install_plugin "$2" "$3"
        ;;
    "uninstall")
        uninstall_plugin "$2" "$3"
        ;;
    "list"|"ls")
        list_plugins "$2"
        ;;
    "activate")
        activate_plugin "$2"
        ;;
    "deactivate")
        deactivate_plugin "$2"
        ;;
    "update")
        update_plugin "$2"
        ;;
    "create")
        create_plugin_template "$2" "$3"
        ;;
    "info")
        show_plugin_info "$2"
        ;;
    *)
        echo "ğŸ”Œ MateOS Plugins System"
        echo ""
        echo "Uso: mateos-plugins <comando> [argumentos]"
        echo ""
        echo "Comandos:"
        echo "  install <fuente> [nombre]        - Instalar plugin"
        echo "  uninstall <nombre> [confirm]     - Desinstalar plugin"
        echo "  list [status]                    - Listar plugins"
        echo "  activate <nombre>                - Activar plugin"
        echo "  deactivate <nombre>              - Desactivar plugin"
        echo "  update <nombre>                  - Actualizar plugin"
        echo "  create <nombre> [descripciÃ³n]     - Crear template de plugin"
        echo "  info <nombre>                    - Mostrar informaciÃ³n del plugin"
        echo ""
        echo "Estados disponibles: all, installed, broken"
        echo ""
        echo "Ejemplos:"
        echo "  mateos-plugins install https://github.com/user/plugin.git"
        echo "  mateos-plugins list installed"
        echo "  mateos-plugins activate my-plugin"
        echo "  mateos-plugins create my-plugin 'Mi plugin personalizado'"
        ;;
esac
