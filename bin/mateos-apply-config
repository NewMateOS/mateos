#!/bin/bash

echo "ğŸ”§ Aplicando configuraciones de MateOS..."
echo ""

MATEOS_PATH="${MATEOS_PATH:-$HOME/.local/share/mateOS}"
BACKUP_DIR="$HOME/.config/mateos-backups/$(date +%Y%m%d-%H%M%S)"

# FunciÃ³n para hacer backup
backup_if_exists() {
    local file="$1"
    if [ -f "$file" ] || [ -d "$file" ]; then
        mkdir -p "$BACKUP_DIR"
        cp -r "$file" "$BACKUP_DIR/" 2>/dev/null
        echo "  ğŸ“¦ Backup: $(basename "$file")"
    fi
}

# 1. Configuraciones de Hyprland
echo "1ï¸âƒ£  Configurando Hyprland..."
if [ -d "$MATEOS_PATH/config/hypr" ]; then
    backup_if_exists "$HOME/.config/hypr"
    mkdir -p "$HOME/.config/hypr"
    cp -r "$MATEOS_PATH/config/hypr/"* "$HOME/.config/hypr/"
    echo "   âœ… Hyprland configurado"
fi

# 2. Waybar
echo "2ï¸âƒ£  Configurando Waybar..."
if [ -d "$MATEOS_PATH/config/waybar" ]; then
    backup_if_exists "$HOME/.config/waybar"
    mkdir -p "$HOME/.config/waybar"
    cp -r "$MATEOS_PATH/config/waybar/"* "$HOME/.config/waybar/"
    echo "   âœ… Waybar configurado"
fi

# 3. Kitty
echo "3ï¸âƒ£  Configurando Kitty..."
if [ -d "$MATEOS_PATH/config/kitty" ]; then
    backup_if_exists "$HOME/.config/kitty"
    mkdir -p "$HOME/.config/kitty"
    cp -r "$MATEOS_PATH/config/kitty/"* "$HOME/.config/kitty/"
    echo "   âœ… Kitty configurado"
fi

# 4. SwayOSD
echo "4ï¸âƒ£  Configurando SwayOSD..."
if [ -d "$MATEOS_PATH/config/swayosd" ]; then
    backup_if_exists "$HOME/.config/swayosd"
    mkdir -p "$HOME/.config/swayosd"
    cp -r "$MATEOS_PATH/config/swayosd/"* "$HOME/.config/swayosd/"
    echo "   âœ… SwayOSD configurado"
fi

# 5. UWSM (ya lo tienes, solo verificar)
echo "5ï¸âƒ£  Verificando UWSM..."
if [ -f "$HOME/.config/uwsm/env" ]; then
    if grep -q "MATEOS_PATH" "$HOME/.config/uwsm/env"; then
        echo "   âœ… UWSM ya configurado"
    else
        echo "   âš ï¸  AÃ±ade esto a ~/.config/uwsm/env:"
        echo "      export MATEOS_PATH=\$HOME/.local/share/mateOS"
        echo "      export PATH=\$MATEOS_PATH/bin/:\$PATH"
    fi
else
    echo "   â„¹ï¸  UWSM no encontrado"
fi

# 6. Walker
echo "6ï¸âƒ£  Configurando Walker..."
if [ -d "$MATEOS_PATH/config/walker" ]; then
    backup_if_exists "$HOME/.config/walker"
    mkdir -p "$HOME/.config/walker"
    cp -r "$MATEOS_PATH/config/walker/"* "$HOME/.config/walker/"
    echo "   âœ… Walker configurado"
fi

# 7. Fontconfig
echo "7ï¸âƒ£  Configurando Fontconfig..."
if [ -f "$MATEOS_PATH/config/fontconfig/fonts.conf" ]; then
    backup_if_exists "$HOME/.config/fontconfig/fonts.conf"
    mkdir -p "$HOME/.config/fontconfig"
    cp "$MATEOS_PATH/config/fontconfig/fonts.conf" "$HOME/.config/fontconfig/"
    echo "   âœ… Fontconfig configurado"
fi

# 8. Systemd services
echo "8ï¸âƒ£  Configurando servicios systemd..."
if [ -d "$MATEOS_PATH/config/systemd" ]; then
    mkdir -p "$HOME/.config/systemd/user"
    cp -r "$MATEOS_PATH/config/systemd/user/"* "$HOME/.config/systemd/user/" 2>/dev/null
    systemctl --user daemon-reload
    echo "   âœ… Servicios systemd copiados"
    echo "   ğŸ’¡ Para activar battery monitor:"
    echo "      systemctl --user enable --now mateos-battery-monitor.timer"
fi

# 9. Starship
echo "9ï¸âƒ£  Configurando Starship..."
if [ -f "$MATEOS_PATH/config/starship.toml" ]; then
    backup_if_exists "$HOME/.config/starship.toml"
    cp "$MATEOS_PATH/config/starship.toml" "$HOME/.config/"
    echo "   âœ… Starship configurado"
fi

# 10. Flags de navegadores
echo "ğŸ”Ÿ Configurando flags de navegadores..."
for flag_file in chromium-flags.conf brave-flags.conf; do
    if [ -f "$MATEOS_PATH/config/$flag_file" ]; then
        backup_if_exists "$HOME/.config/$flag_file"
        cp "$MATEOS_PATH/config/$flag_file" "$HOME/.config/"
        echo "   âœ… $(basename $flag_file) configurado"
    fi
done

# Crear estructura de MateOS
echo ""
echo "ğŸ“ Creando estructura de directorios..."
mkdir -p "$HOME/.config/mateos/"{themes,current,hooks}
mkdir -p "$HOME/.local/state/mateos/toggles"
echo "   âœ… Directorios creados"

# Resumen
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ConfiguraciÃ³n aplicada!"
echo ""
if [ -d "$BACKUP_DIR" ]; then
    echo "ğŸ“¦ Backup guardado en:"
    echo "   $BACKUP_DIR"
    echo ""
fi
echo "ğŸ”„ Para aplicar los cambios:"
echo "   â€¢ Reinicia Hyprland: hyprctl reload"
echo "   â€¢ O reinicia sesiÃ³n completa"
echo ""
echo "ğŸ’¡ Siguiente paso:"
echo "   source ~/.config/uwsm/env"
echo "   mateos-verify"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
