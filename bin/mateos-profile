#!/bin/bash

# MateOS Profile Manager
# Gestor de perfiles de usuario de MateOS

MATEOS_PATH="${MATEOS_PATH:-$HOME/.local/share/mateOS}"
PROFILES_DIR="$MATEOS_PATH/profiles"
CURRENT_PROFILE_FILE="$HOME/.config/mateOS/current-profile"

# FunciÃ³n para listar perfiles disponibles
list_profiles() {
    echo "ğŸ‘¤ Perfiles disponibles de MateOS:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    local profiles=("default" "development" "gaming" "server" "minimal")
    local current=$(get_current_profile)
    
    for profile in "${profiles[@]}"; do
        if [ "$profile" = "$current" ]; then
            echo "  âœ… $profile (actual)"
        else
            echo "  âšª $profile"
        fi
    done
    
    echo ""
    echo "ğŸ’¡ Usa: mateos-profile set <perfil> para cambiar"
}

# FunciÃ³n para obtener perfil actual
get_current_profile() {
    if [ -f "$CURRENT_PROFILE_FILE" ]; then
        cat "$CURRENT_PROFILE_FILE"
    else
        echo "default"
    fi
}

# FunciÃ³n para establecer perfil
set_profile() {
    local profile="$1"
    
    if [ -z "$profile" ]; then
        echo "âŒ Error: Debes especificar un perfil"
        echo "Uso: mateos-profile set <perfil>"
        exit 1
    fi
    
    # Validar perfil
    local valid_profiles=("default" "development" "gaming" "server" "minimal")
    local valid=false
    
    for valid_profile in "${valid_profiles[@]}"; do
        if [ "$profile" = "$valid_profile" ]; then
            valid=true
            break
        fi
    done
    
    if [ "$valid" = false ]; then
        echo "âŒ Error: Perfil '$profile' no vÃ¡lido"
        echo "Perfiles disponibles: ${valid_profiles[*]}"
        exit 1
    fi
    
    # Crear directorio si no existe
    mkdir -p "$(dirname "$CURRENT_PROFILE_FILE")"
    
    # Guardar perfil actual
    echo "$profile" > "$CURRENT_PROFILE_FILE"
    
    # Aplicar configuraciÃ³n del perfil
    apply_profile "$profile"
    
    echo "âœ… Perfil cambiado a: $profile"
    echo "ğŸ”„ Reinicia tu sesiÃ³n para aplicar todos los cambios"
}

# FunciÃ³n para aplicar configuraciÃ³n de perfil
apply_profile() {
    local profile="$1"
    
    echo "ğŸ”§ Aplicando configuraciÃ³n del perfil: $profile"
    echo ""
    
    case "$profile" in
        "default")
            apply_default_profile
            ;;
        "development")
            apply_development_profile
            ;;
        "gaming")
            apply_gaming_profile
            ;;
        "server")
            apply_server_profile
            ;;
        "minimal")
            apply_minimal_profile
            ;;
    esac
}

# FunciÃ³n para aplicar perfil por defecto
apply_default_profile() {
    echo "ğŸ“‹ ConfiguraciÃ³n por defecto:"
    echo "  â€¢ Animaciones habilitadas"
    echo "  â€¢ Waybar completo"
    echo "  â€¢ Todas las aplicaciones disponibles"
    echo "  â€¢ ConfiguraciÃ³n estÃ¡ndar de Hyprland"
}

# FunciÃ³n para aplicar perfil de desarrollo
apply_development_profile() {
    echo "ğŸ’» ConfiguraciÃ³n de desarrollo:"
    echo "  â€¢ Docker habilitado"
    echo "  â€¢ Git hooks activados"
    echo "  â€¢ Herramientas de debug"
    echo "  â€¢ Workspace 2 por defecto"
    echo "  â€¢ Terminal con configuraciÃ³n de desarrollo"
    
    # Configurar workspace por defecto
    if command -v hyprctl &>/dev/null; then
        hyprctl dispatch workspace 2
    fi
}

# FunciÃ³n para aplicar perfil de gaming
apply_gaming_profile() {
    echo "ğŸ® ConfiguraciÃ³n de gaming:"
    echo "  â€¢ Modo gaming activado"
    echo "  â€¢ Compositor deshabilitado para mejor rendimiento"
    echo "  â€¢ Gamepad habilitado"
    echo "  â€¢ Workspace 3 por defecto"
    echo "  â€¢ Optimizaciones de rendimiento"
    
    # Configurar workspace por defecto
    if command -v hyprctl &>/dev/null; then
        hyprctl dispatch workspace 3
    fi
}

# FunciÃ³n para aplicar perfil de servidor
apply_server_profile() {
    echo "ğŸ–¥ï¸  ConfiguraciÃ³n de servidor:"
    echo "  â€¢ SSH habilitado"
    echo "  â€¢ Acceso remoto configurado"
    echo "  â€¢ Aplicaciones GUI deshabilitadas"
    echo "  â€¢ Monitoreo del sistema activado"
    echo "  â€¢ ConfiguraciÃ³n optimizada para servidor"
}

# FunciÃ³n para aplicar perfil minimalista
apply_minimal_profile() {
    echo "ğŸ¯ ConfiguraciÃ³n minimalista:"
    echo "  â€¢ Animaciones deshabilitadas"
    echo "  â€¢ Waybar minimalista"
    echo "  â€¢ Tray deshabilitado"
    echo "  â€¢ Solo aplicaciones esenciales"
    echo "  â€¢ ConfiguraciÃ³n ligera"
}

# FunciÃ³n para mostrar informaciÃ³n del perfil actual
show_profile() {
    local current=$(get_current_profile)
    
    echo "ğŸ‘¤ Perfil actual de MateOS: $current"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    case "$current" in
        "default")
            echo "ğŸ“‹ Perfil por defecto"
            echo "  ConfiguraciÃ³n estÃ¡ndar para uso general"
            ;;
        "development")
            echo "ğŸ’» Perfil de desarrollo"
            echo "  Optimizado para programaciÃ³n y desarrollo"
            ;;
        "gaming")
            echo "ğŸ® Perfil de gaming"
            echo "  Optimizado para juegos y entretenimiento"
            ;;
        "server")
            echo "ğŸ–¥ï¸  Perfil de servidor"
            echo "  Optimizado para uso como servidor"
            ;;
        "minimal")
            echo "ğŸ¯ Perfil minimalista"
            echo "  ConfiguraciÃ³n ligera y minimalista"
            ;;
    esac
    
    echo ""
    echo "ğŸ’¡ Usa: mateos-profile list para ver todos los perfiles"
}

# FunciÃ³n para crear perfil personalizado
create_profile() {
    local profile_name="$1"
    
    if [ -z "$profile_name" ]; then
        echo "âŒ Error: Debes especificar un nombre para el perfil"
        echo "Uso: mateos-profile create <nombre>"
        exit 1
    fi
    
    # Validar nombre del perfil
    if [[ ! "$profile_name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        echo "âŒ Error: El nombre del perfil solo puede contener letras, nÃºmeros, guiones y guiones bajos"
        exit 1
    fi
    
    local profile_dir="$PROFILES_DIR/$profile_name"
    
    if [ -d "$profile_dir" ]; then
        echo "âŒ Error: El perfil '$profile_name' ya existe"
        exit 1
    fi
    
    # Crear directorio del perfil
    mkdir -p "$profile_dir"
    
    # Crear archivo de configuraciÃ³n del perfil
    cat > "$profile_dir/config.conf" << EOF
# ConfiguraciÃ³n del perfil: $profile_name
# Creado el: $(date)

[profile]
name = "$profile_name"
description = "Perfil personalizado"
created = "$(date)"

[hyprland]
# ConfiguraciÃ³n especÃ­fica de Hyprland para este perfil
gaps_in = 5
gaps_out = 10
rounding = 8

[waybar]
# ConfiguraciÃ³n especÃ­fica de Waybar para este perfil
height = 26
position = "top"

[applications]
# Aplicaciones especÃ­ficas para este perfil
default_terminal = "kitty"
default_browser = "chromium"
EOF
    
    echo "âœ… Perfil personalizado '$profile_name' creado"
    echo "ğŸ“ UbicaciÃ³n: $profile_dir"
    echo "ğŸ’¡ Edita $profile_dir/config.conf para personalizar"
}

# FunciÃ³n para eliminar perfil personalizado
remove_profile() {
    local profile_name="$1"
    
    if [ -z "$profile_name" ]; then
        echo "âŒ Error: Debes especificar un nombre para el perfil"
        echo "Uso: mateos-profile remove <nombre>"
        exit 1
    fi
    
    # No permitir eliminar perfiles del sistema
    local system_profiles=("default" "development" "gaming" "server" "minimal")
    for sys_profile in "${system_profiles[@]}"; do
        if [ "$profile_name" = "$sys_profile" ]; then
            echo "âŒ Error: No se puede eliminar el perfil del sistema '$profile_name'"
            exit 1
        fi
    done
    
    local profile_dir="$PROFILES_DIR/$profile_name"
    
    if [ ! -d "$profile_dir" ]; then
        echo "âŒ Error: El perfil '$profile_name' no existe"
        exit 1
    fi
    
    # Confirmar eliminaciÃ³n
    echo "âš ï¸  Â¿EstÃ¡s seguro de que quieres eliminar el perfil '$profile_name'?"
    echo "Esta acciÃ³n no se puede deshacer."
    read -p "Escribe 'yes' para confirmar: " confirm
    
    if [ "$confirm" = "yes" ]; then
        rm -rf "$profile_dir"
        echo "âœ… Perfil '$profile_name' eliminado"
    else
        echo "âŒ OperaciÃ³n cancelada"
    fi
}

# FunciÃ³n principal
case "$1" in
    "list"|"ls")
        list_profiles
        ;;
    "set")
        set_profile "$2"
        ;;
    "show"|"current")
        show_profile
        ;;
    "create")
        create_profile "$2"
        ;;
    "remove"|"rm")
        remove_profile "$2"
        ;;
    "apply")
        apply_profile "$2"
        ;;
    *)
        echo "ğŸ‘¤ MateOS Profile Manager"
        echo ""
        echo "Uso: mateos-profile <comando> [argumentos]"
        echo ""
        echo "Comandos:"
        echo "  list, ls              - Listar perfiles disponibles"
        echo "  set <perfil>           - Cambiar a un perfil"
        echo "  show, current          - Mostrar perfil actual"
        echo "  create <nombre>        - Crear perfil personalizado"
        echo "  remove <nombre>       - Eliminar perfil personalizado"
        echo "  apply <perfil>         - Aplicar configuraciÃ³n de perfil"
        echo ""
        echo "Perfiles disponibles:"
        echo "  default               - ConfiguraciÃ³n por defecto"
        echo "  development           - Optimizado para desarrollo"
        echo "  gaming                - Optimizado para gaming"
        echo "  server                - Optimizado para servidor"
        echo "  minimal               - ConfiguraciÃ³n minimalista"
        echo ""
        echo "Ejemplos:"
        echo "  mateos-profile list"
        echo "  mateos-profile set development"
        echo "  mateos-profile create my-profile"
        echo "  mateos-profile show"
        ;;
esac
