#!/bin/bash

# MateOS Configuration Manager
# Gestor de configuraciÃ³n central de MateOS

MATEOS_PATH="${MATEOS_PATH:-$HOME/.local/share/mateOS}"
CONFIG_FILE="$MATEOS_PATH/config/mateos.conf"

# FunciÃ³n para leer configuraciÃ³n
get_config() {
    local section="$1"
    local key="$2"
    
    if [ -f "$CONFIG_FILE" ]; then
        # Buscar la secciÃ³n y luego la clave
        awk -F'=' -v section="$section" -v key="$key" '
        BEGIN { in_section = 0 }
        /^\[/ { 
            if ($0 == "[" section "]") { in_section = 1; next }
            else { in_section = 0; next }
        }
        in_section && gsub(/^[ \t]+|[ \t]+$/, "", $1) && $1 == key { 
            gsub(/^[ \t]+|[ \t]+$/, "", $2)
            gsub(/^"|"$/, "", $2)
            print $2
            exit
        }
        ' "$CONFIG_FILE"
    fi
}

# FunciÃ³n para escribir configuraciÃ³n
set_config() {
    local section="$1"
    local key="$2"
    local value="$3"
    
    if [ ! -f "$CONFIG_FILE" ]; then
        echo "Error: Archivo de configuraciÃ³n no encontrado: $CONFIG_FILE"
        exit 1
    fi
    
    # Crear backup
    cp "$CONFIG_FILE" "$CONFIG_FILE.bak.$(date +%s)"
    
    # Actualizar configuraciÃ³n
    awk -F'=' -v section="$section" -v key="$key" -v value="$value" '
    BEGIN { in_section = 0; updated = 0 }
    /^\[/ { 
        if ($0 == "[" section "]") { in_section = 1; print; next }
        else { in_section = 0; print; next }
    }
    in_section && $1 == key { 
        print key " = \"" value "\""
        updated = 1
        next
    }
    { print }
    END {
        if (!updated && in_section) {
            print key " = \"" value "\""
        }
    }
    ' "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
}

# FunciÃ³n para mostrar configuraciÃ³n
show_config() {
    local section="$1"
    
    if [ -n "$section" ]; then
        echo "ğŸ”§ ConfiguraciÃ³n de MateOS - SecciÃ³n: $section"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        awk -v section="$section" '
        BEGIN { in_section = 0 }
        /^\[/ { 
            if ($0 == "[" section "]") { in_section = 1; next }
            else { in_section = 0; next }
        }
        in_section && /^[^#]/ && /=/ { 
            gsub(/^[ \t]+|[ \t]+$/, "", $0)
            print "  " $0
        }
        ' "$CONFIG_FILE"
    else
        echo "ğŸ”§ ConfiguraciÃ³n de MateOS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        cat "$CONFIG_FILE" | grep -E '^\[|^[a-zA-Z]' | while read line; do
            if [[ $line =~ ^\[.*\]$ ]]; then
                echo ""
                echo "ğŸ“ ${line//[\[\]]/}"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            else
                echo "  $line"
            fi
        done
    fi
}

# FunciÃ³n para validar configuraciÃ³n
validate_config() {
    echo "ğŸ” Validando configuraciÃ³n de MateOS..."
    echo ""
    
    local errors=0
    
    # Verificar archivo de configuraciÃ³n
    if [ ! -f "$CONFIG_FILE" ]; then
        echo "âŒ Archivo de configuraciÃ³n no encontrado: $CONFIG_FILE"
        ((errors++))
    else
        echo "âœ… Archivo de configuraciÃ³n encontrado"
    fi
    
    # Verificar secciones requeridas
    local required_sections=("system" "paths" "applications" "hyprland" "waybar")
    for section in "${required_sections[@]}"; do
        if grep -q "^\[$section\]" "$CONFIG_FILE"; then
            echo "âœ… SecciÃ³n [$section] presente"
        else
            echo "âŒ SecciÃ³n [$section] faltante"
            ((errors++))
        fi
    done
    
    # Verificar rutas
    local mateos_path=$(get_config "paths" "mateos_path")
    if [ -z "$mateos_path" ]; then
        echo "âŒ Ruta de MateOS no configurada"
        ((errors++))
    elif [ -d "${mateos_path//\$HOME/$HOME}" ]; then
        echo "âœ… Ruta de MateOS vÃ¡lida: $mateos_path"
    else
        echo "âŒ Ruta de MateOS invÃ¡lida: $mateos_path"
        ((errors++))
    fi
    
    if [ $errors -eq 0 ]; then
        echo ""
        echo "âœ… ConfiguraciÃ³n vÃ¡lida"
    else
        echo ""
        echo "âŒ Se encontraron $errors errores en la configuraciÃ³n"
    fi
    
    return $errors
}

# FunciÃ³n para resetear configuraciÃ³n
reset_config() {
    echo "ğŸ”„ Reseteando configuraciÃ³n a valores por defecto..."
    
    if [ -f "$CONFIG_FILE" ]; then
        cp "$CONFIG_FILE" "$CONFIG_FILE.backup.$(date +%s)"
        echo "ğŸ“¦ Backup creado"
    fi
    
    # Restaurar desde template
    if [ -f "$MATEOS_PATH/config/mateos.conf" ]; then
        cp "$MATEOS_PATH/config/mateos.conf" "$CONFIG_FILE"
        echo "âœ… ConfiguraciÃ³n reseteada"
    else
        echo "âŒ No se pudo encontrar template de configuraciÃ³n"
        exit 1
    fi
}

# FunciÃ³n para aplicar configuraciÃ³n
apply_config() {
    echo "ğŸ”§ Aplicando configuraciÃ³n de MateOS..."
    echo ""
    
    # Aplicar variables de entorno
    local mateos_path=$(get_config "paths" "mateos_path")
    local config_path=$(get_config "paths" "config_path")
    local state_path=$(get_config "paths" "state_path")
    
    # Expandir variables
    mateos_path="${mateos_path//\$HOME/$HOME}"
    config_path="${config_path//\$HOME/$HOME}"
    state_path="${state_path//\$HOME/$HOME}"
    
    # Crear directorios necesarios
    mkdir -p "$config_path" "$state_path" "$state_path/logs"
    echo "âœ… Directorios creados"
    
    # Aplicar configuraciÃ³n de Hyprland
    local gaps_in=$(get_config "hyprland" "gaps_in")
    local gaps_out=$(get_config "hyprland" "gaps_out")
    local rounding=$(get_config "hyprland" "rounding")
    
    if [ -n "$gaps_in" ] && [ -n "$gaps_out" ]; then
        echo "âœ… ConfiguraciÃ³n de Hyprland aplicada"
    fi
    
    # Aplicar configuraciÃ³n de Waybar
    local waybar_height=$(get_config "waybar" "height")
    local waybar_position=$(get_config "waybar" "position")
    
    if [ -n "$waybar_height" ]; then
        echo "âœ… ConfiguraciÃ³n de Waybar aplicada"
    fi
    
    echo ""
    echo "âœ… ConfiguraciÃ³n aplicada exitosamente"
}

# FunciÃ³n principal
case "$1" in
    "get")
        if [ -z "$2" ] || [ -z "$3" ]; then
            echo "Uso: mateos-config get <secciÃ³n> <clave>"
            exit 1
        fi
        get_config "$2" "$3"
        ;;
    "set")
        if [ -z "$2" ] || [ -z "$3" ] || [ -z "$4" ]; then
            echo "Uso: mateos-config set <secciÃ³n> <clave> <valor>"
            exit 1
        fi
        set_config "$2" "$3" "$4"
        echo "âœ… ConfiguraciÃ³n actualizada: [$2] $3 = $4"
        ;;
    "show")
        show_config "$2"
        ;;
    "validate")
        validate_config
        ;;
    "reset")
        reset_config
        ;;
    "apply")
        apply_config
        ;;
    *)
        echo "ğŸ”§ MateOS Configuration Manager"
        echo ""
        echo "Uso: mateos-config <comando> [argumentos]"
        echo ""
        echo "Comandos:"
        echo "  get <secciÃ³n> <clave>     - Obtener valor de configuraciÃ³n"
        echo "  set <secciÃ³n> <clave> <valor> - Establecer valor de configuraciÃ³n"
        echo "  show [secciÃ³n]            - Mostrar configuraciÃ³n"
        echo "  validate                  - Validar configuraciÃ³n"
        echo "  reset                     - Resetear a valores por defecto"
        echo "  apply                     - Aplicar configuraciÃ³n"
        echo ""
        echo "Ejemplos:"
        echo "  mateos-config get hyprland gaps_in"
        echo "  mateos-config set hyprland gaps_in 10"
        echo "  mateos-config show hyprland"
        echo "  mateos-config validate"
        ;;
esac
