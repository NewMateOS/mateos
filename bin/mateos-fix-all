#!/bin/bash

# MateOS Fix All - Script para corregir todos los fallos de comandos
# Sistema de correcci√≥n masiva de problemas identificados

MATEOS_PATH="${MATEOS_PATH:-$HOME/.local/share/mateOS}"

# Cargar variables de entorno
if [ -f "$MATEOS_PATH/config/mateos-vars.sh" ]; then
    source "$MATEOS_PATH/config/mateos-vars.sh"
fi

# Colores para la salida
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Funci√≥n para agregar estructura de ayuda est√°ndar
add_help_structure() {
    local cmd_path="$1"
    local cmd_name=$(basename "$cmd_path" | sed 's/mateos-//')
    
    # Verificar si ya tiene estructura de ayuda
    if grep -q -E "(^# Uso:|^Usage:)" "$cmd_path" && grep -q -E "(^# Comandos:|^Commands:)" "$cmd_path"; then
        return 0
    fi
    
    echo "üîß Agregando estructura de ayuda a: $cmd_name"
    
    # Crear backup
    cp "$cmd_path" "$cmd_path.backup" 2>/dev/null
    
    # Crear archivo temporal con estructura de ayuda
    cat > "$cmd_path.tmp" << EOF
#!/bin/bash

# Cargar variables de entorno centralizadas
MATEOS_PATH="\${MATEOS_PATH:-\$HOME/.local/share/mateOS}"
if [ -f "\$MATEOS_PATH/config/mateos-vars.sh" ]; then
    source "\$MATEOS_PATH/config/mateos-vars.sh"
fi

# =============================================================================
# AYUDA DEL COMANDO
# =============================================================================

# Uso: mateos-$cmd_name [argumentos]
# Descripci√≥n: [DESCRIPCI√ìN DEL COMANDO]
# 
# Comandos:
#   [comando1]    - [descripci√≥n del comando1]
#   [comando2]    - [descripci√≥n del comando2]
# 
# Ejemplos:
#   mateos-$cmd_name [ejemplo1]
#   mateos-$cmd_name [ejemplo2]
# 
# Variables de entorno:
#   MATEOS_PATH: \$MATEOS_PATH
#   HOME: \$HOME
#   USER: \$USER

# =============================================================================
# FUNCIONES PRINCIPALES
# =============================================================================

# Funci√≥n para mostrar ayuda
show_help() {
    echo "üîß mateos-$cmd_name"
    echo ""
    echo "Uso: mateos-$cmd_name [argumentos]"
    echo ""
    echo "Descripci√≥n: [DESCRIPCI√ìN DEL COMANDO]"
    echo ""
    echo "Comandos:"
    echo "  [comando1]    - [descripci√≥n del comando1]"
    echo "  [comando2]    - [descripci√≥n del comando2]"
    echo ""
    echo "Ejemplos:"
    echo "  mateos-$cmd_name [ejemplo1]"
    echo "  mateos-$cmd_name [ejemplo2]"
    echo ""
    echo "Variables de entorno:"
    echo "  MATEOS_PATH: \$MATEOS_PATH"
    echo "  HOME: \$HOME"
    echo "  USER: \$USER"
}

# Funci√≥n principal
main() {
    case "\$1" in
        "help"|"-h"|"--help")
            show_help
            ;;
        "")
            show_help
            ;;
        *)
            # Aqu√≠ va la l√≥gica principal del comando
            echo "Ejecutando: mateos-$cmd_name con argumentos: \${@:1}"
            ;;
    esac
}

# Ejecutar funci√≥n principal
main "\$@"
EOF
    
    # Reemplazar archivo original
    mv "$cmd_path.tmp" "$cmd_path"
    chmod +x "$cmd_path"
    
    echo "‚úÖ Estructura de ayuda agregada a: $cmd_name"
}

# Funci√≥n para corregir variables no definidas
fix_undefined_variables() {
    local cmd_path="$1"
    local cmd_name=$(basename "$cmd_path")
    
    echo "üîß Corrigiendo variables en: $cmd_name"
    
    # Crear backup
    cp "$cmd_path" "$cmd_path.backup" 2>/dev/null
    
    # Agregar definici√≥n de variables al inicio del archivo
    cat > "$cmd_path.tmp" << 'EOF'
#!/bin/bash

# Cargar variables de entorno centralizadas
MATEOS_PATH="${MATEOS_PATH:-$HOME/.local/share/mateOS}"
if [ -f "$MATEOS_PATH/config/mateos-vars.sh" ]; then
    source "$MATEOS_PATH/config/mateos-vars.sh"
fi

# Variables adicionales si se necesitan
APP_NAME="${APP_NAME:-}"
DEBUG="${DEBUG:-false}"
XKB_KEYMAP_CACHE="${XKB_KEYMAP_CACHE:-/tmp/xkb-cache}"

EOF
    
    # Agregar contenido original (saltando shebang si existe)
    if head -1 "$cmd_path" | grep -q "^#!/"; then
        tail -n +2 "$cmd_path" >> "$cmd_path.tmp"
    else
        cat "$cmd_path" >> "$cmd_path.tmp"
    fi
    
    # Reemplazar archivo original
    mv "$cmd_path.tmp" "$cmd_path"
    chmod +x "$cmd_path"
    
    echo "‚úÖ Variables corregidas en: $cmd_name"
}

# Funci√≥n para corregir un comando espec√≠fico
fix_command() {
    local cmd_path="$1"
    local cmd_name=$(basename "$cmd_path")
    
    echo -e "${BLUE}üîß Corrigiendo: $cmd_name${NC}"
    
    # 1. Corregir variables no definidas
    fix_undefined_variables "$cmd_path"
    
    # 2. Agregar estructura de ayuda si no la tiene
    if ! grep -q -E "(^# Uso:|^Usage:)" "$cmd_path" || ! grep -q -E "(^# Comandos:|^Commands:)" "$cmd_path"; then
        add_help_structure "$cmd_path"
    fi
    
    echo -e "${GREEN}‚úÖ Comando corregido: $cmd_name${NC}"
}

# Funci√≥n para corregir todos los comandos
fix_all_commands() {
    echo -e "${BLUE}üîß Corrigiendo todos los comandos de MateOS...${NC}"
    echo ""
    
    local total=0
    local fixed=0
    
    # Categor√≠as a procesar
    local categories=("system" "apps" "packages" "themes" "dev" "webapps" "utils")
    
    for category in "${categories[@]}"; do
        if [ -d "$MATEOS_PATH/bin/$category" ]; then
            echo -e "${BLUE}üìÅ Procesando categor√≠a: $category${NC}"
            
            for script in "$MATEOS_PATH/bin/$category"/mateos-*; do
                if [ -f "$script" ]; then
                    total=$((total + 1))
                    fix_command "$script"
                    fixed=$((fixed + 1))
                    echo ""
                fi
            done
        fi
    done
    
    echo -e "${BLUE}üìä Resumen:${NC}"
    echo "  Total de comandos: $total"
    echo -e "  ${GREEN}Comandos corregidos: $fixed${NC}"
}

# Funci√≥n para restaurar desde backup
restore_from_backup() {
    echo -e "${YELLOW}üîÑ Restaurando desde backups...${NC}"
    
    local restored=0
    
    for category in system apps packages themes dev webapps utils; do
        if [ -d "$MATEOS_PATH/bin/$category" ]; then
            for script in "$MATEOS_PATH/bin/$category"/mateos-*; do
                if [ -f "$script" ] && [ -f "$script.backup" ]; then
                    mv "$script.backup" "$script"
                    restored=$((restored + 1))
                    echo "‚úÖ Restaurado: $(basename "$script")"
                fi
            done
        fi
    done
    
    echo "üìä Comandos restaurados: $restored"
}

# Funci√≥n para limpiar backups
clean_backups() {
    echo -e "${YELLOW}üßπ Limpiando archivos de backup...${NC}"
    
    local cleaned=0
    
    for category in system apps packages themes dev webapps utils; do
        if [ -d "$MATEOS_PATH/bin/$category" ]; then
            for backup in "$MATEOS_PATH/bin/$category"/*.backup; do
                if [ -f "$backup" ]; then
                    rm "$backup"
                    cleaned=$((cleaned + 1))
                fi
            done
        fi
    done
    
    echo "üìä Archivos de backup eliminados: $cleaned"
}

# Funci√≥n para mostrar ayuda
show_help() {
    echo "üîß MateOS Fix All - Correcci√≥n Masiva de Comandos"
    echo ""
    echo "Uso: mateos-fix-all <comando>"
    echo ""
    echo "Comandos:"
    echo "  all                     - Corregir todos los comandos"
    echo "  command <ruta>          - Corregir un comando espec√≠fico"
    echo "  restore                 - Restaurar desde backups"
    echo "  clean                   - Limpiar archivos de backup"
    echo "  help                    - Mostrar esta ayuda"
    echo ""
    echo "Ejemplos:"
    echo "  mateos-fix-all all"
    echo "  mateos-fix-all command /path/to/script"
    echo "  mateos-fix-all restore"
    echo "  mateos-fix-all clean"
}

# Funci√≥n principal
case "$1" in
    "all")
        fix_all_commands
        ;;
    "command")
        if [ -z "$2" ]; then
            echo "‚ùå Se requiere ruta del comando"
            exit 1
        fi
        fix_command "$2"
        ;;
    "restore")
        restore_from_backup
        ;;
    "clean")
        clean_backups
        ;;
    "help"|"-h"|"--help")
        show_help
        ;;
    *)
        echo "‚ùå Comando desconocido: $1"
        show_help
        exit 1
        ;;
esac
